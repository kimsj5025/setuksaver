<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/setuksaver/icon.png">
    <title>멀글세 (멀티 글자수 세기)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 기본 폰트 및 커스텀 스타일 */
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }

        /* data-status 속성에 따른 동적 배경색 변화 */
        .block[data-status="draft"] { background-color: #fee2e2; /* red-100 */ }
        .block[data-status="in-progress"] { background-color: #fef9c3; /* yellow-100 */ }
        .block[data-status="completed"] { background-color: #dcfce7; /* green-100 */ }
        
        .index-item[data-status="draft"] { background-color: #fecaca; /* red-200 */ }
        .index-item[data-status="in-progress"] { background-color: #fef08a; /* yellow-200 */ }
        .index-item[data-status="completed"] { background-color: #bbf7d0; /* green-200 */ }

        /* 스크롤바 스타일 (선택 사항) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- 주 컨테이너 -->
    <div class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- 헤더 -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-900">멀티 글자수 세기 📝</h1>
            <p class="text-slate-600 mt-2">과목별 세특 내용을 효율적으로 관리하고 글자 수를 확인하세요.</p>
        </header>

        <!-- 탭 컨테이너 -->
        <div class="flex justify-center bg-slate-200 rounded-xl p-1 mb-6">
            <button class="tab-button flex-1 py-2 px-4 rounded-lg text-lg font-semibold transition-colors duration-300" data-grade="1">1학년</button>
            <button class="tab-button flex-1 py-2 px-4 rounded-lg text-lg font-semibold transition-colors duration-300" data-grade="2">2학년</button>
            <button class="tab-button flex-1 py-2 px-4 rounded-lg text-lg font-semibold transition-colors duration-300" data-grade="3">3학년</button>
        </div>

        <!-- 액션 버튼 그룹 -->
        <div class="flex flex-wrap justify-center gap-4 mb-4">
            <button id="addBlock" class="flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-indigo-700 transition-all duration-300 transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                과목 추가
            </button>
            <button id="indexShortcut" class="flex items-center gap-2 bg-white text-slate-700 font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-slate-50 transition-all duration-300 border border-slate-300">
                🔖 인덱스 바로가기
            </button>
        </div>

        <!-- 저장 상태 메시지 -->
        <div class="save-status text-center text-green-600 font-medium h-6 mb-4" id="saveStatus"></div>

        <!-- 블록 컨테이너 -->
        <div id="container" class="space-y-6"></div>

        <!-- 인덱스 컨테이너 -->
        <div class="index-container mt-12 p-6 bg-white rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4 text-slate-800">과목 인덱스</h2>
            <div class="index-list flex flex-wrap gap-3" id="indexList"></div>
        </div>
        
        <!-- 푸터 및 데이터 관리 -->
        <footer class="text-center mt-12 space-y-4">
            <div class="flex justify-center gap-4">
                <button id="downloadData" class="bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-800 transition-colors">백업</button>
                <button id="uploadDataBtn" class="bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-800 transition-colors">백업 파일 업로드</button>
                <input type="file" id="fileInput" class="hidden">
            </div>
            <div class="warning-message text-sm text-red-600 font-medium">
                데이터는 브라우저에 저장되지만, 만약을 위해 꼭 백업을 하시기 바랍니다.
            </div>
             <div class="selection-info fixed left-4 bottom-4 bg-gray-900 bg-opacity-80 text-white text-sm py-2 px-4 rounded-lg shadow-lg z-50" id="selectionInfo">선택한 글자 바이트 수: 0</div>
            <div class="flex justify-center items-center mt-6">
                <a href="https://github.com/kimsj5025/setuksaver" target="_blank" class="hover:scale-110 transition-transform">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" class="text-slate-600 hover:text-black">
                    <path d="M12 0C5.373 0 0 5.373 0 12c0 5.303 3.438 9.8 8.205 11.387.6.113.82-.26.82-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.73.083-.73 1.205.085 1.84 1.237 1.84 1.237 1.07 1.834 2.809 1.304 3.495.997.108-.775.419-1.304.762-1.603-2.665-.304-5.466-1.333-5.466-5.931 0-1.31.469-2.381 1.236-3.221-.124-.303-.536-1.524.117-3.176 0 0 1.008-.322 3.3 1.23a11.5 11.5 0 0 1 3.003-.404c1.018.005 2.044.138 3.003.404 2.291-1.552 3.297-1.23 3.297-1.23.654 1.653.243 2.874.12 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.804 5.624-5.475 5.921.43.371.823 1.102.823 2.222v3.293c0 .32.218.694.825.576C20.565 21.796 24 17.3 24 12c0-6.627-5.373-12-12-12z"/>
                  </svg>
                </a>
            </div>
            <div class="flex justify-center items-center mt-6">
                <img src="https://hitscounter.dev/api/hit?url=https%3A%2F%2Fkimsj5025.github.io%2Fsetuksaver%2F&label=Views&icon=bookmark-fill&color=%23198754&message=&style=flat&tz=UTC">
            </div>
            <p class="text-slate-500 text-sm">made by kimCastleOwner</p>
        </footer>
    </div>

    <!-- 스크롤 버튼 -->
    <div class="scroll-buttons fixed right-5 bottom-5 z-50 flex flex-col gap-3">
        <button id="scrollTop" class="w-12 h-12 rounded-full bg-indigo-600 text-white shadow-lg flex items-center justify-center hover:bg-indigo-700 transition-all transform hover:-translate-y-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
        </button>
        <button id="scrollBottom" class="w-12 h-12 rounded-full bg-indigo-600 text-white shadow-lg flex items-center justify-center hover:bg-indigo-700 transition-all transform hover:translate-y-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
        </button>
    </div>
    
    <!-- 삭제 확인 모달 -->
    <div id="deleteModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 m-4 max-w-sm w-full">
            <h3 class="text-xl font-bold text-slate-800 mb-4">정말 삭제하시겠습니까?</h3>
            <p class="text-slate-600 mb-6">이 작업은 되돌릴 수 없습니다.</p>
            <div class="flex justify-end gap-4">
                <button id="cancelDelete" class="py-2 px-4 bg-slate-200 text-slate-800 font-semibold rounded-lg hover:bg-slate-300 transition-colors">취소</button>
                <button id="confirmDelete" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors">삭제</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 전역 변수 및 상태 ---
            let currentGrade = '1';
            const gradeData = { '1': [], '2': [], '3': [] };
            let blockToDelete = null; // 삭제할 블록을 임시 저장
            let draggedItem = null; // 드래그 중인 인덱스 아이템

            // --- DOM 요소 ---
            const container = document.getElementById("container");
            const saveStatusEl = document.getElementById('saveStatus');
            const indexListEl = document.getElementById("indexList");
            const selectionInfoEl = document.getElementById('selectionInfo');
            const deleteModal = document.getElementById('deleteModal');
            const confirmDeleteBtn = document.getElementById('confirmDelete');
            const cancelDeleteBtn = document.getElementById('cancelDelete');

            // --- 함수 정의 ---

            // 저장 상태 메시지 표시
            function showSaveStatus(message) {
                saveStatusEl.textContent = message;
                setTimeout(() => saveStatusEl.textContent = '', 1500);
            }

            // 로컬 스토리지에 데이터 저장
            function saveBlocksToLocalStorage() {
                const blocks = [];
                document.querySelectorAll(".block").forEach(block => {
                    blocks.push({
                        id: block.id, // ID 저장
                        title: block.querySelector(".title-input").value,
                        text: block.querySelector(".text-area").value,
                        status: block.dataset.status,
                        collapsed: block.classList.contains('collapsed')
                    });
                });
                gradeData[currentGrade] = blocks;
                localStorage.setItem("gradeData", JSON.stringify(gradeData));
                localStorage.setItem("lastGrade", currentGrade);
                showSaveStatus('자동 저장 완료!');
                updateIndex();
            }

            // 로컬 스토리지에서 데이터 불러오기
            function loadBlocksFromLocalStorage() {
                const data = localStorage.getItem("gradeData");
                if (data) {
                    Object.assign(gradeData, JSON.parse(data));
                }
                const lastGrade = localStorage.getItem("lastGrade");
                if (lastGrade) {
                    currentGrade = lastGrade;
                }
                updateActiveTab();
                loadGradeBlocks(currentGrade);
            }
            
            // 현재 학년 탭 활성화
            function updateActiveTab() {
                document.querySelectorAll(".tab-button").forEach(btn => {
                    if (btn.dataset.grade === currentGrade) {
                        btn.classList.add("bg-white", "text-indigo-600", "shadow");
                        btn.classList.remove("text-slate-700");
                    } else {
                        btn.classList.remove("bg-white", "text-indigo-600", "shadow");
                        btn.classList.add("text-slate-700");
                    }
                });
            }

            // 특정 학년 블록 로드
            function loadGradeBlocks(grade) {
                container.innerHTML = '';
                if (gradeData[grade]) {
                    gradeData[grade].forEach(data => addBlock(data.title, data.text, data.status, data.collapsed, false, data.id));
                }
                updateIndex();
            }
            
            // 새 블록 추가
            function addBlock(title = "", text = "", status = "draft", collapsed = false, shouldScroll = true, id = null) {
                const block = document.createElement("div");
                block.className = `block p-6 rounded-2xl shadow-lg transition-all duration-300 relative ${collapsed ? 'collapsed' : ''}`;
                block.dataset.status = status;
                // ID가 없으면 새로 생성, 있으면 기존 ID 사용
                block.id = id || `block-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

                const byteSize = new Blob([text]).size;

                block.innerHTML = `
                    <div class="block-header flex justify-between items-start mb-4">
                        <input type="text" placeholder="과목명" class="title-input text-xl font-bold w-full bg-transparent focus:outline-none" value="${title}">
                        
                        <div class="flex items-center gap-4 ml-4 flex-shrink-0">
                            <div class="status-buttons flex items-center gap-2">
                                <button data-status="draft" class="status-button w-6 h-6 rounded-full bg-red-400 border-2 border-white shadow hover:scale-110 transition-transform" title="초안"></button>
                                <button data-status="in-progress" class="status-button w-6 h-6 rounded-full bg-yellow-400 border-2 border-white shadow hover:scale-110 transition-transform" title="수정중"></button>
                                <button data-status="completed" class="status-button w-6 h-6 rounded-full bg-green-400 border-2 border-white shadow hover:scale-110 transition-transform" title="완료"></button>
                            </div>
                            <div class="block-actions flex items-center gap-2">
                                <button class="collapse-button p-2 rounded-full bg-slate-200 hover:bg-slate-300 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300 ${collapsed ? 'rotate-180' : ''}">
                                        <polyline points="18 15 12 9 6 15"></polyline>
                                    </svg>
                                </button>
                                <button class="delete-button p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="content-wrapper overflow-hidden transition-all duration-500 ease-in-out ${collapsed ? 'max-h-0' : 'max-h-screen'}">
                        <textarea placeholder="세특 내용" class="text-area w-full h-48 p-4 bg-white/50 rounded-lg border-2 border-slate-200 focus:border-indigo-500 focus:ring-indigo-500 focus:outline-none resize-y transition-colors" style="margin-top: 0px; margin-bottom: 0px; height: 400px;">${text}</textarea>
                        <div class="byte-count text-right text-slate-500 mt-2 font-medium">${byteSize} bytes</div>
                    </div>
                `;

                container.appendChild(block);

                // 이벤트 리스너 연결
                const titleInput = block.querySelector(".title-input");
                const textArea = block.querySelector(".text-area");
                const byteCount = block.querySelector(".byte-count");
                const collapseButton = block.querySelector(".collapse-button");
                const deleteButton = block.querySelector(".delete-button");
                const statusButtons = block.querySelectorAll(".status-button");

                titleInput.addEventListener("input", saveBlocksToLocalStorage);
                textArea.addEventListener("input", () => {
                    byteCount.textContent = new Blob([textArea.value]).size + " bytes";
                    saveBlocksToLocalStorage();
                });

                collapseButton.addEventListener("click", () => {
                    block.classList.toggle("collapsed");
                    block.querySelector('.content-wrapper').classList.toggle('max-h-0');
                    block.querySelector('.content-wrapper').classList.toggle('max-h-screen');
                    block.querySelector('.collapse-button svg').classList.toggle('rotate-180');
                    saveBlocksToLocalStorage();
                });

                deleteButton.addEventListener("click", () => {
                    blockToDelete = block;
                    deleteModal.classList.remove('hidden');
                });
                
                statusButtons.forEach(button => {
                    button.addEventListener("click", () => {
                        block.dataset.status = button.dataset.status;
                        saveBlocksToLocalStorage();
                    });
                });

                if (shouldScroll) {
                    block.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                updateIndex();
            }

            // 인덱스 업데이트
            function updateIndex() {
                indexListEl.innerHTML = '';
                document.querySelectorAll(".block").forEach(block => {
                    const title = block.querySelector(".title-input").value.trim();
                    if (title) {
                        const status = block.dataset.status;
                        const item = document.createElement("div");
                        item.className = "index-item text-sm font-semibold py-2 px-4 rounded-full cursor-pointer hover:scale-105 transition-transform";
                        item.dataset.status = status;
                        item.textContent = title;
                        item.draggable = true; // 드래그 가능하도록 설정
                        item.dataset.blockId = block.id; // 블록 ID 연결

                        item.addEventListener('click', () => {
                            block.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            block.classList.remove('collapsed');
                            block.querySelector('.content-wrapper').classList.remove('max-h-0');
                            block.querySelector('.content-wrapper').classList.add('max-h-screen');
                            block.querySelector('.collapse-button svg').classList.remove('rotate-180');
                        });
                        indexListEl.appendChild(item);
                    }
                });
            }

            // 데이터 다운로드
            function downloadData() {
                const dataStr = JSON.stringify(gradeData, null, 2); // 보기 좋게 포맷팅
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `setuk_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // 데이터 업로드
            function uploadData(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        // 데이터 유효성 검사 (간단하게)
                        if (data['1'] && data['2'] && data['3']) {
                            Object.assign(gradeData, data);
                            loadGradeBlocks(currentGrade);
                            saveBlocksToLocalStorage();
                            alert('백업 데이터 복원에 성공했습니다.');
                        } else {
                            alert('유효하지 않은 백업 파일입니다.');
                        }
                    } catch (error) {
                        alert('파일을 읽는 중 오류가 발생했습니다.');
                        console.error("Upload error:", error);
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // 같은 파일 다시 올릴 수 있도록 초기화
            }

            // [FIXED] 드래그 앤 드롭 위치 계산 함수 (x, y 좌표 모두 사용)
            function getDragAfterElement(container, x, y) {
                const draggableElements = [...container.querySelectorAll('.index-item:not(.opacity-50)')];

                // 가장 가까운 요소를 찾음
                const result = draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const centerX = box.left + box.width / 2;
                    const centerY = box.top + box.height / 2;
                    // 커서와 요소 중심 사이의 거리를 계산
                    const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));

                    if (distance < closest.distance) {
                        return { distance: distance, element: child };
                    } else {
                        return closest;
                    }
                }, { distance: Number.POSITIVE_INFINITY, element: null });

                // 가장 가까운 요소가 없으면 null 반환
                if (!result.element) {
                    return null;
                }

                const closestElement = result.element;
                const box = closestElement.getBoundingClientRect();

                // 커서가 가장 가까운 요소의 중심보다 오른쪽에 있으면
                // 그 요소의 다음에 위치해야 함 (즉, 다음 형제 요소 앞에 삽입)
                if (x > box.left + box.width / 2) {
                    return closestElement.nextElementSibling;
                } else {
                    // 커서가 왼쪽에 있으면 그 요소 자체의 앞에 삽입
                    return closestElement;
                }
            }


            // --- 이벤트 리스너 설정 ---

            // 탭 버튼
            document.querySelectorAll(".tab-button").forEach(button => {
                button.addEventListener("click", () => {
                    currentGrade = button.dataset.grade;
                    updateActiveTab();
                    loadGradeBlocks(currentGrade);
                    localStorage.setItem("lastGrade", currentGrade);
                });
            });

            // 스크롤 버튼
            document.getElementById('scrollTop').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
            document.getElementById('scrollBottom').addEventListener('click', () => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }));

            // 기능 버튼
            document.getElementById("addBlock").addEventListener("click", () => addBlock());
            document.getElementById("indexShortcut").addEventListener("click", () => document.querySelector('.index-container').scrollIntoView({ behavior: 'smooth' }));
            document.getElementById("downloadData").addEventListener("click", downloadData);
            document.getElementById("uploadDataBtn").addEventListener("click", () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', uploadData);

            // 삭제 모달
            confirmDeleteBtn.addEventListener('click', () => {
                if (blockToDelete) {
                    blockToDelete.remove();
                    saveBlocksToLocalStorage();
                }
                deleteModal.classList.add('hidden');
                blockToDelete = null;
            });
            cancelDeleteBtn.addEventListener('click', () => {
                deleteModal.classList.add('hidden');
                blockToDelete = null;
            });

            // 선택된 텍스트 바이트 계산
            document.addEventListener('selectionchange', () => {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const selectedText = selection.toString();
                    const charCount = new Blob([selectedText]).size;
                    selectionInfoEl.textContent = `선택한 글자 바이트 수: ${charCount}`;
                }
            });

            // --- 인덱스 드래그 앤 드롭 이벤트 리스너 ---
            indexListEl.addEventListener('dragstart', e => {
                if (e.target.classList.contains('index-item')) {
                    draggedItem = e.target;
                    // 드래그 시작 시 약간 투명하게 만들어 시각적 피드백 제공
                    setTimeout(() => {
                        e.target.classList.add('opacity-50');
                    }, 0);
                }
            });

            indexListEl.addEventListener('dragend', e => {
                if (draggedItem) {
                    // 드래그 종료 시 투명도 복원
                    draggedItem.classList.remove('opacity-50');
                    
                    // DOM 순서에 따라 메인 블록 재정렬
                    const orderedIds = [...indexListEl.querySelectorAll('.index-item')].map(item => item.dataset.blockId);
                    orderedIds.forEach(id => {
                        const blockElement = document.getElementById(id);
                        if (blockElement) {
                            container.appendChild(blockElement);
                        }
                    });

                    // 변경된 순서 저장
                    saveBlocksToLocalStorage();
                    draggedItem = null;
                }
            });

            // [FIXED] dragover 이벤트 핸들러 (y 좌표 추가)
            indexListEl.addEventListener('dragover', e => {
                e.preventDefault(); // drop 이벤트를 허용하기 위해 기본 동작 방지
                const afterElement = getDragAfterElement(indexListEl, e.clientX, e.clientY);
                if (draggedItem) {
                    if (afterElement == null) {
                        indexListEl.appendChild(draggedItem);
                    } else {
                        indexListEl.insertBefore(draggedItem, afterElement);
                    }
                }
            });

            // --- 초기화 ---
            loadBlocksFromLocalStorage();
        });
    </script>
</body>
</html>
